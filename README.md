# Bond Metrics Project

Этот проект представляет собой микросервис на FastAPI для получения рассчитанных метрик по облигациям. 

### Функционал
- получение основной информации по повыбранной облигации 
- получение автоматически рассчитываемых метрик (текущей доходности, доходности к погашению и справедливой стоимости) по выбранной облигации и вывода по ним
- получение коэффициентов корреляции (_Пирсона, Спирмена, Кендалла, корреляции, рассчитанной на основе регрессии_) между двумя выбранными облигациями и получение рекомендаций по выбору наиболее подходящего коэффициента на основе проверки данных на нормальность и наличие выбросов.

### Техническая реализация
Микросервис реализован как API на **FastAPI**. В качестве базы данных используется **PostgreSQL**.
Данные в базе данных обновляются ежедневно в 00:05 с помощью расписания в **Airflow**. Также база данных автоматически заполняется данными при первичном запуске контейнера Docker.
Запросы к базе данных осуществляются посредством **SQLAlchemy**.
Миграции базы данных выполняются с помощью **Alembic**. 

### Требования
- Python 3.8+
- Docker

### Установка
1. Клонируйте репозиторий:
```bash
git clone https://github.com/homeycoon/bond_metrics_project.git
cd bond_metrics_project
```
2. Создайте файлы:
- `.env` (заполнить переменные по примеру .env.example)
- `.env.docker` (заполнить переменные по примеру .env.docker.example)
- `.env.db` (заполнить переменные по примеру .env.db.example)
3. Запустите в терминале команду:
```bash
docker-compose up --build
```
Начнется сборка и запуск контейнеров. Дождитесь появления в терминале сообщения о завершении запуска приложения и сервера.
4. Для тестирования сервиса в Swagger откройте в браузере путь `127.0.0.1:8000/docs`

### Использование сервиса
После запуска база данных будет наполнена свежими данными по облигациям, выгруженными через API Московской биржи, и данными по курсам валют, выгруженным по API ЦБ РФ.

В дальнейшем данные по облигациям и курсам валют будут обновляться ежедневно в 00:05 посредством запуска DAG в Airflow.

### API эндпоинты
1. `GET /bonds/`
- Описание: получение информации о тикерах и названиях доступных облигаций
- Шаблон ответа:
```bash
[
    {
        "ticker": "RU000A0AAAA1",      # тикер облигации
        "name": "ООО Рога и копыта",   # название облигации
    }
]
```
2. `GET /bonds/{ticker}/info`
- Описание: получение основной информации по конкретной облигации
- Шаблон ответа:
```bash
{
  "ticker": "RU000A0AAAA1",      # тикер облигации
  "name": "ООО Рога и копыта",   # название облигации
  "prevwaprice_cur": "90",       # средневзвешенная цена облигации прыдущего торгового дня в валюте номинала
  "prevwaprice_rub": "900",      # средневзвешенная цена облигации прыдущего торгового дня в валюте номинала
  "nominal_cur": "100",          # номинал в валюте номинала
  "nominal_rub": "1000",         # номинал в российской валюте
  "coupon_value_cur": "10",      # размер купона в валюте номинала
  "coupon_value_rub": "100",     # размер купона в российской валюте
  "coupon_period": 91,           # период купона в днях
  "accum_coupon_cur": "9",       # накопленный купонный доход в валюте номинала
  "accum_coupon_rub": "90",      # накопленный купонный доход в россйской валюте
  "cur_of_nominal": "EUR",       # текущая цена облигации в валюте номанала
  "cur_of_market": "SUR",        # текущая цена облигации в российской валюте
  "lot_size": 1,                 # размер лота
  "issue_size": 100000,          # объем выпуска
  "prev_date": "2024-11-02T11:29:50.638Z",         # дата предыдущего торгового дня
  "next_coupon_date": "2024-11-06T11:29:50.638Z",  # дата следующего купона
  "maturity_date": "2025-11-05T11:29:50.638Z",     # дата погашения
  "loading_date": "2024-11-05T11:29:50.638Z"       # дата загрузки данных
}
```
3. `GET /bonds/{ticker}/metrics`
- Описание: получение рассчитанных метрик по конкретной облигации
- Шаблон ответа:
```bash
{
  "ticker": "RU000A0AAAA1",     # тикер облигации
  "name": "ООО Рога и копыта",  # название облигации
  "current_yield": "8.2525",    # текущая доходность по облигации в российской валюте
  "ytm_prct": "20.2525",        # доходность к погашению облигации в российской валюте
  "fair_value": "1100.9998"     # справедливая цена облигации в российской валюте
  "conclusion": "Справедливая стоимость превышает средневзвешенную цену. Облигация может быть недооценена. Доходность к погашению 20.25% может быть привлекательна для Вас, так как превышает введенную ставку дисконтирования 10.00%. ВАЖНО: не является индивидуальной инвестиционной рекомендацией (ИИР)"
}
```
4. `GET /bonds/correlation`
- Описание: получение информации о корреляции между ценами двух конкретных облигаций
- Шаблон ответа:
```bash
{
  "ticker_1": "RU000A0AAAA1",           # тикер первой облигации
  "name_1": "ООО Рога и копыта",        # название первой облигации
  "ticker_2": "RU000A0BBBB2",           # тикер второй облигации
  "name_2": "ООО Копыта и рога",        # название второй облигации
  "Pearson_correlation": 0.13131313,    # коэффициент корреляции Пирсона
  "Spearman_correlation": 0.24242424,   # коэффициент корреляции Спирмена
  "Kendall_correlation": 0.35353535,    # коэффициент корреляции Кендалла
  "Robust_correlation": 0.00000000,     # коэффициент робастной корреляции
  "Advice": "string"                    # рекомендация по наиболее подходящему коэффициенту корреляции
}
```
